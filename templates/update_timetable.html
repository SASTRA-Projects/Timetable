<!-- Copyright 2025 Harikrishna Srinivasan

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->


{% extends "layout.html" %}

{% block title %}Update Timetable{% endblock %}

{% block head %}
<meta name="description" content="Add, delete or update timetable.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .timetable-container {
        width: 100%;
        padding: 1.5rem;
    }

    .table-wrapper {
        overflow-x: auto;
        width: 100%;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--input-border-light);
        background: var(--bg);
    }
    [data-theme="dark"] .table-wrapper {
        border-color: var(--input-border-dark);
    }

    .timetable {
        width: 100%;
        min-width: 1000px;
        border-collapse: collapse;
        background: var(--bg);
    }

    /* --- Borders & Cells --- */
    .timetable th, .timetable td {
        border: 1px solid #cbd5e1;
        text-align: center;
        padding: 0; /* Reset padding for cell content */
    }
    [data-theme="dark"] .timetable th, 
    [data-theme="dark"] .timetable td {
        border-color: #475569;
    }

    /* --- Header Styling --- */
    .timetable th {
        background-color: #f8fafc;
        padding: 12px 8px;
        font-weight: 700;
        font-size: 0.85rem;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    [data-theme="dark"] .timetable th {
        background-color: #1e293b;
        color: #e2e8f0;
    }

    /* --- Day Column (First Column) --- */
    .timetable td:first-child {
        font-weight: 700;
        width: 100px;
        background-color: #f1f5f9;
        color: #334155;
        padding: 1rem;
    }
    
    /* Specific Requirement: White BG in Dark Mode */
    [data-theme="dark"] .timetable td:first-child {
        background-color: #ffffff;
        color: #000000;
        border-right: 1px solid #000;
    }

    /* --- Interactive Cells --- */
    .timetable-cell {
        cursor: context-menu;
        height: 80px;
        vertical-align: top;
        font-size: 0.8rem;
        position: relative;
        padding: 6px;
        transition: background-color 0.2s;
    }
    .timetable-cell:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }
    [data-theme="dark"] .timetable-cell:hover {
        background-color: rgba(59, 130, 246, 0.2);
    }
    
    .entry-badge {
        display: block;
        background: #ffffff;
        border-left: 3px solid #3b82f6;
        border: 1px solid #e2e8f0;
        border-left-width: 3px;
        padding: 4px 8px;
        margin-bottom: 4px;
        border-radius: 4px;
        font-size: 0.75rem;
        text-align: left;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    [data-theme="dark"] .entry-badge {
        background: #334155;
        border-color: #475569;
        border-left-color: #60a5fa;
        color: #f8fafc;
    }

    /* --- High Visibility Modal --- */
    #manage-modal {
        display: none; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100vw; height: 100vh; 
        background: rgba(0,0,0,0.6); 
        z-index: 1000; 
        align-items: center; 
        justify-content: center;
        padding: 1rem;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: #ffffff; /* Explicit White for Light Mode */
        color: #1e293b;
        padding: 0;
        border-radius: 12px;
        width: 600px; /* Wider Modal */
        max-width: 95vw;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Deep shadow */
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }
    [data-theme="dark"] .modal-content {
        background: #1e293b;
        color: #f1f5f9;
        border-color: #475569;
    }

    .modal-header {
        padding: 1.25rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    [data-theme="dark"] .modal-header {
        background: #0f172a;
        border-color: #334155;
    }

    .modal-body {
        padding: 2rem;
    }

    /* Form Layout */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }
    
    .form-label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
    }
    [data-theme="dark"] .form-label { color: #94a3b8; }

    .form-input, .form-select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #fff;
        color: #0f172a;
    }
    [data-theme="dark"] .form-input, 
    [data-theme="dark"] .form-select {
        background: #334155;
        border-color: #475569;
        color: #f1f5f9;
    }

    .entries-list {
        background: #f1f5f9;
        border-radius: 6px;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
        max-height: 150px;
        overflow-y: auto;
    }
    [data-theme="dark"] .entries-list { background: #0f172a; }

    .entry-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: #fff;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }
    [data-theme="dark"] .entry-item { 
        background: #1e293b; 
        border-color: #334155; 
    }
</style>
{% endblock %}

{% block content %}
<div class="timetable-container">
    <div class="page-header">
        <h1>Update Timetable</h1>
    </div>

    <form id="filter-form" method="get" action="/update_timetable" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center; justify-content: center; background: var(--menu-footer-bg-light); padding: 1rem; border-radius: 8px;">
        <select name="campus" class="form-select" style="width:auto;" required>
            <option value="" disabled {% if not campus %}selected{% endif %}>Choose Campus</option>
            {% for c in campuses %}
            <option value="{{ c['name'] }}" {% if campus == c['name'] %}selected{% endif %}>{{ c['name'] }}</option>
            {% endfor %}
        </select>
        <select name="degree" class="form-select" style="width:auto;" required>
            <option value="" disabled {% if not degree %}selected{% endif %}>Choose Degree</option>
            {% for d in degrees %}
            <option value="{{ d }}" {% if degree == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
        </select>
        <select name="stream" class="form-select" style="width:auto;">
            <option value="" {% if stream == "" %}selected{% endif %}>No Stream</option>
            {% for s in streams if s %}
            <option value="{{ s }}" {% if stream == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
        <select name="year" class="form-select" style="width:80px;" required>
            <option value="" disabled {% if not year %}selected{% endif %}>Year</option>
            {% for y in years %}
            <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <select name="section" class="form-select" style="width:80px;" required>
            <option value="" disabled {% if not section %}selected{% endif %}>Sec</option>
            {% for sec in sections %}
            <option value="{{ sec }}" {% if section == sec %}selected{% endif %}>{{ sec }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="action-button">Fetch</button>
    </form>

    <div id="timetable-export-area">
        {% if grid %}
        <div class="table-wrapper">
            <table class="timetable">
                <thead>
                    <tr>
                        <th>Day</th>
                        {% for i in range(1, 9) %}
                        <th>Period {{ i }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"] %}
                    <tr>
                        <td>{{ day }}</td>
                        {% for period in range(1, 9) %}
                            <td class="timetable-cell" 
                                data-day="{{ day }}" 
                                data-period="{{ period }}"
                                data-entries='{{ grid[day][period] | tojson }}'>
                                {% for entry in grid[day][period] %}
                                    <div class="entry-badge">
                                        <b>{{ entry.course_code }}</b><br>
                                        {{ entry.faculty_id }}
                                    </div>
                                {% endfor %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif section_id %}
            <div style="text-align:center; padding: 3rem; background: rgba(0,0,0,0.02); border: 2px dashed #cbd5e1; border-radius: 8px;">
                <h3 style="color: #64748b;">Ready to Schedule</h3>
                <p style="color: #94a3b8;">Right-click any cell to manage entries.</p>
            </div>
        {% endif %}
    </div>
</div>

<div id="manage-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; font-size:1.1rem;"><i class="fas fa-calendar-check" style="color:#3b82f6; margin-right:8px;"></i> Manage Slot</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#64748b;">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="form-label" style="margin-bottom:0.5rem;">Current Assignments</div>
            <div id="existing-entries-list" class="entries-list"></div>

            <hr style="border:0; border-top:1px solid #e2e8f0; margin: 1.5rem 0;">

            <div class="form-label" style="margin-bottom:1rem; color:#3b82f6;">Add New Assignment</div>
            <form id="add-entry-form">
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Course Code</label>
                        <input type="text" name="course_code" required class="form-input" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Faculty ID</label>
                        <input type="text" name="faculty_id" required class="form-input">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select name="is_lab" class="form-select">
                            <option value="0">Theory</option>
                            <option value="1">Lab</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="is_elective" class="form-select">
                            <option value="0">Core</option>
                            <option value="1">Elective</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Batch</label>
                        <select name="full_batch" class="form-select">
                            <option value="1">Full</option>
                            <option value="0">Partial</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Class ID <span style="font-weight:400; text-transform:none; color:#94a3b8;">(Optional)</span></label>
                    <input type="number" name="class_id" class="form-input" placeholder="e.g. 101">
                </div>

                <input type="hidden" name="day">
                <input type="hidden" name="period">
                <input type="hidden" name="section_id" value="{{ section_id }}">

                <button type="submit" class="action-button" style="width:100%; justify-content:center; padding:0.8rem;">Add Entry</button>
            </form>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('manage-modal');
    const form = document.getElementById('add-entry-form');
    const existingList = document.getElementById('existing-entries-list');

    function closeModal() {
        modal.style.display = 'none';
        form.reset();
    }

    // Right Click Logic
    document.querySelectorAll('.timetable-cell').forEach(cell => {
        cell.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const secId = document.querySelector('[name=section_id]').value;
            if(!secId || secId === 'None') return alert("Fetch a timetable first.");

            form.day.value = this.dataset.day;
            form.period.value = this.dataset.period;

            // Render existing
            const entries = JSON.parse(this.dataset.entries || '[]');
            existingList.innerHTML = '';
            
            if(entries.length === 0) {
                existingList.innerHTML = '<div style="text-align:center; padding:1rem; color:#94a3b8; font-style:italic;">No entries in this slot</div>';
            } else {
                entries.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'entry-item';
                    div.innerHTML = `
                        <div>
                            <span style="font-weight:700; color:#3b82f6;">${entry.course_code}</span>
                            <span style="color:#64748b; font-size:0.85rem; margin-left:0.5rem;">${entry.faculty_id}</span>
                        </div>
                        <button onclick="deleteEntry('${entry.faculty_id}', '${entry.course_code}', '${this.dataset.day}', '${this.dataset.period}')" 
                                style="color:#ef4444; background:none; border:none; cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    existingList.appendChild(div);
                });
            }

            modal.style.display = 'flex';
        });
    });

    // Form Submit
    form.onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Clean Integers
        ['class_id', 'is_lab', 'is_elective', 'full_batch', 'period', 'section_id'].forEach(k => {
            if(data[k]) data[k] = parseInt(data[k]);
        });
        if(data.course_code) data.course_code = data.course_code.toUpperCase();

        fetch('/add_timetable_entry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.success) {
                location.reload();
            } else {
                alert(resp.message || "Error adding entry.");
            }
        });
    };

    window.deleteEntry = function(facId, code, day, period) {
        if(!confirm("Delete this entry?")) return;
        fetch('/delete_timetable_entry', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                faculty_id: facId, course_code: code, day: day, period: parseInt(period),
                section_id: parseInt(document.querySelector('[name=section_id]').value)
            })
        }).then(r => r.json()).then(resp => {
            if(resp.success) location.reload();
            else alert(resp.message);
        });
    };
    
    window.onclick = function(event) { if (event.target == modal) closeModal(); }
</script>
{% endblock %}